name: Build, test and deploy (split)

on:
  workflow_dispatch:
  push:
    branches:
      - "**"
    tags:
      - "v*"
  pull_request:

jobs:
  build:
    name: Build, check & test
    runs-on: ubuntu-latest
    outputs:
      app_ids: ${{ steps.list-affected.outputs.app_ids }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Moon toolchain
        uses: moonrepo/setup-toolchain@v0
        with:
          auto-install: true

      # Optional: Ensure PostgreSQL client (which includes pg_config) is installed
      # ubuntu-latest usually has it, but being explicit can be safer.
      - name: Install PostgreSQL client (if needed)
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      # Find the PostgreSQL bin directory and add it to the PATH
      - name: Add PostgreSQL bin directory to PATH
        run: |
          PG_BIN_DIR=$(pg_config --bindir)
          echo "Found PostgreSQL bin directory: $PG_BIN_DIR"
          echo "$PG_BIN_DIR" >> $GITHUB_PATH
        shell: bash # Explicitly use bash for command substitution

      # Verify that the command is now available
      - name: Verify initdb is in PATH
        run: |
          which initdb
          initdb --version # Example command using the newly available tool

      - name: Set PNPM store directory
        run: |
          pnpm config set store-dir .pnpm-store

      - name: Get cached PNPM store
        uses: actions/cache@v3
        with:
          path: .pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: pnpm install

      - name: Get Moon cache
        uses: actions/cache@v3
        with:
          path: .moon
          key: ${{ runner.os }}-moon-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-moon-

      - name: Get base and head for affected commands
        id: vars
        run: |
          git fetch origin main --depth=2
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "MOON_BASE=HEAD~1" >> $GITHUB_ENV
            echo "MOON_HEAD=HEAD" >> $GITHUB_ENV
          else
            echo "MOON_BASE=origin/main" >> $GITHUB_ENV
            echo "MOON_HEAD=${{ github.sha }}" >> $GITHUB_ENV
          fi

      - name: Check affected packages
        run: moon ci :build :typecheck :test

      - name: List affected apps
        id: list-affected
        run: |
          echo "app_ids=$(moon query projects --affected --json --tags type.app | jq -c '[.projects[].id]')" >> $GITHUB_OUTPUT

  docker:
    name: Containerize
    needs: [build]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.CONTAINER_REGISTRY_ENDPOINT}}/repro
          tags: |
            type=schedule
            type=ref,event=branch
            type=ref,event=tag
            type=ref,event=pr

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.CONTAINER_REGISTRY_ENDPOINT }}
          username: ${{ secrets.CONTAINER_REGISTRY_USERNAME }}
          password: ${{ secrets.CONTAINER_REGISTRY_PASSWORD }}

      - name: Build base Docker image
        uses: docker/build-push-action@v6
        with:
          cache-from: type=registry,ref=${{ secrets.CONTAINER_REGISTRY_ENDPOINT }}/repro:build-cache
          cache-to: type=registry,ref=${{ secrets.CONTAINER_REGISTRY_ENDPOINT }}/repro:build-cache
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          file: infra/Dockerfile
          push: true

  deploy-workspace:
    name: Deploy workspace
    needs: [build]
    runs-on: ubuntu-latest
    if: ${{ contains(fromJSON(needs.build.outputs.app_ids), 'repro/workspace') }}
    steps:
      - name: Log
        run: |
          echo "Deploying workspace"
